// Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://edgvrwekvnavkhcqwtxa.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZ3Zyd2Vrdm5hdmtoY3F3dHhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNDkzNTAsImV4cCI6MjA1OTgyNTM1MH0.Qg5zp-QZPFMcB1IsnxaCZMP7zh7fcrqY_6BV4hyp21E'
);

const cart = [];
let priceMultiplier = 1;

// Î∞∞ÏÜ°ÎπÑ ÏÉÅÏàò Î∞è Î™©Î°ù ÏÑ†Ïñ∏
const DELIVERY_FEE = 3000;
const DELIVERY_FREE_METHODS = [
  "Ïù¥Ï≤úÏ∞ΩÍ≥† ÏßÅÏ†ë ÏàòÎ†π",
  "ÎèÑÎß§ Ï£ºÎ¨∏Í≥º Ìï©Î∞∞ÏÜ°",
  "ÏñëÏû¨Ï†ê ÏàòÎ†π",
  "Ïö©ÏÇ∞Ï†ê ÏàòÎ†π",
  "ÌïòÎÇ®Ï†ê ÏàòÎ†π"
];

// ‚úÖ DOMContentLoaded Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
document.addEventListener("DOMContentLoaded", () => {
  // üîπ Ï†ÑÏó≠ Îì±Î°ù
  window.removeItem = removeItem;

  // üîπ Ï†ïÎ≥¥ ÏàòÏ†ï Í∞ÄÎä• Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Îì±Î°ù
  const unlockEditCheckbox = document.getElementById("unlockEdit");
  if (unlockEditCheckbox) {
    unlockEditCheckbox.addEventListener("change", (e) => {
      toggleEdit(e.target);
    });
  }

  // üîπ Î∞∞ÏÜ° Î∞©Î≤ï Î≥ÄÍ≤Ω Ïãú ÎπÑÍ≥†ÎûÄ ÏóÖÎç∞Ïù¥Ìä∏
  const deliverySelect = document.getElementById("deliveryMethod");
  if (deliverySelect) {
    deliverySelect.addEventListener("change", (event) => {
      const selectedMethod = event.target.value;
      const remarksField = document.getElementById("remarks");

      if (selectedMethod === "") {
        remarksField.value = ""; // Îπà Í∞íÏúºÎ°ú Ï¥àÍ∏∞Ìôî
      } else {
        remarksField.value = selectedMethod;
      }
    });
  }
});

// ‚úÖ Ï†ïÎ≥¥ ÏàòÏ†ï Í∞ÄÎä• ÌÜ†Í∏Ä Ìï®Ïàò
function toggleEdit(checkbox) {
  const editableFields = [
    document.getElementById("supplierContact"),
    document.getElementById("supplierAddress"),
    document.getElementById("supplierEmail"),
    document.getElementById("supplierZipcode")
  ];

  editableFields.forEach(field => {
    if (field) {
      if (checkbox.checked) {
        field.removeAttribute('readonly');
        field.removeAttribute('disabled');
        field.classList.remove('disabled-input');
      } else {
        field.setAttribute('readonly', true);
        field.setAttribute('disabled', true);
        field.classList.add('disabled-input');
      }
    }
  });
}

// ‚úÖ ÏÉÅÌíà Í≤ÄÏÉâ Î∞è Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä
async function searchProduct() {
  const productCode = document.getElementById("productCode").value.trim();
  if (!productCode) {
    alert("Ï†úÌíà ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  try {
    const { data, error } = await supabase
      .from('tamiya_items')
      .select('*')
      .eq('item_code', productCode)
      .single();

    if (error || !data) {
      alert("Ìï¥Îãπ Ï†úÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
      return;
    }

    const isEightDigit = productCode.length === 8;
    const multiplier = isEightDigit ? 15 : 13;
    const price = data.j_retail * multiplier * priceMultiplier;
    const consumerPrice = data.j_retail * multiplier;

    const existingItem = cart.find(item => item.code === data.item_code);

    if (existingItem) {
      existingItem.qty += 1;
    } else {
      cart.push({
        code: data.item_code,
        name: data.description,
        price: Math.round(price),
        consumerPrice: Math.round(consumerPrice),
        qty: 1
      });
    }

    renderCart();
  } catch (err) {
    console.error("ÏÉÅÌíà Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù:", err.message);
    alert("ÏÉÅÌíàÏùÑ Í≤ÄÏÉâÌïòÎäî ÎèôÏïà Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
  }
}

// ‚úÖ Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®Ìïú Ï¥ù Í∏àÏï° Í≥ÑÏÇ∞
function calculateTotalWithShipping() {
  let total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

  if (cart.length === 0) {
    document.getElementById("cartTotal").textContent = `‚Ç©0`;
    return;
  }

  const deliveryMethod = document.getElementById("deliveryMethod").value;

  if (total < 30000 && !DELIVERY_FREE_METHODS.includes(deliveryMethod)) {
    total += DELIVERY_FEE;
  }

  document.getElementById("cartTotal").textContent = `‚Ç©${total.toLocaleString()}`;
}

// ‚úÖ Ïû•Î∞îÍµ¨Îãà ÏàòÎüâ ÏóÖÎç∞Ïù¥Ìä∏
function updateQty(index, value) {
  const newQty = parseInt(value, 10);
  if (isNaN(newQty) || newQty < 1) {
    alert("ÏàòÎüâÏùÄ 1Í∞ú Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.");
    renderCart();
    return;
  }
  cart[index].qty = newQty;
  renderCart();
}

// ‚úÖ Ïû•Î∞îÍµ¨Îãà Î†åÎçîÎßÅ
function renderCart() {
  const tbody = document.getElementById("cartBody");
  tbody.innerHTML = "";

  cart.forEach((item, index) => {
    const rowTotal = item.price * item.qty;

    tbody.innerHTML += `
      <tr>
        <td>${item.code}</td>
        <td>${item.name}</td>
        <td>‚Ç©${item.consumerPrice.toLocaleString()}</td>
        <td>‚Ç©${item.price.toLocaleString()}</td>
        <td><input type="number" value="${item.qty}" min="1" onchange="updateQty(${index}, this.value)"></td>
        <td>‚Ç©${rowTotal.toLocaleString()}</td>
        <td><button onclick="removeItem(${index})">üóëÔ∏è</button></td>
      </tr>
    `;
  });

  calculateTotalWithShipping();
}

// ‚úÖ Ïû•Î∞îÍµ¨Îãà Ìï≠Î™© ÏÇ≠Ï†ú
function removeItem(index) {
  cart.splice(index, 1);
  renderCart();
}

/////////////////////////////////////////////////////
// ‚úÖ ÏÇ¨ÏóÖÏûê Ï†ïÎ≥¥ Í≤ÄÏÉâ (ÏÇ¨ÏóÖÏûêÎ≤àÌò∏ ÎòêÎäî ÏóÖÏ≤¥Î™Ö)
/////////////////////////////////////////////////////
async function searchSupplier() {
  const keyword = document.getElementById("searchKeyword").value.trim();

  if (!keyword) {
    alert("ÏÇ¨ÏóÖÏûêÎ≤àÌò∏ ÎòêÎäî ÏóÖÏ≤¥Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  try {
    let query = supabase.from('suppliers').select('*');

    if (/^[0-9]{3}-[0-9]{2}-[0-9]{5}$/.test(keyword)) {
      query = query.eq('business_registration_number', keyword);
    } else {
      query = query.eq('company_name', keyword);
    }

    const { data, error } = await query.single();

    if (error || !data) {
      alert("Ìï¥Îãπ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");

      // ‚úÖ Ï¥àÍ∏∞Ìôî Ï≤òÎ¶¨
      document.getElementById("supplierName").value = "";
      document.getElementById("businessNumberDisplay").value = "";
      document.getElementById("supplierContact").value = "";
      document.getElementById("supplierAddress").value = "";
      document.getElementById("supplierEmail").value = "";
      const zipcodeField = document.getElementById("supplierZipcode");
      if (zipcodeField) {
        zipcodeField.value = "";
      }

      return;
    }

    // ‚úÖ ÌôîÎ©¥Ïóê Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
    document.getElementById("supplierName").value = data.company_name;
    document.getElementById("businessNumberDisplay").value = data.business_registration_number;
    document.getElementById("supplierContact").value = formatPhoneNumber(data.phone);
    document.getElementById("supplierAddress").value = data.address;
    document.getElementById("supplierEmail").value = data.email;

    // ‚úÖ zipcodeÍ∞Ä ÏûàÎäî Í≤ΩÏö∞Îßå ÏÑ§Ï†ï
    const zipcodeField = document.getElementById("supplierZipcode");
    if (zipcodeField) {
      zipcodeField.value = data.zipcode;
    }
    
    // ‚úÖ Í∞ÄÍ≤© Î∞∞Ïàò ÏÑ§Ï†ï
    priceMultiplier = parseFloat(data.price_multiplier);

  } catch (error) {
    console.error("Fetch Error:", error.message);
    alert("Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
  }
}

/////////////////////////////////////////////////////
// ‚úÖ Ï†ÑÌôîÎ≤àÌò∏ Ìè¨Îß∑ÌÑ∞
/////////////////////////////////////////////////////
function formatPhoneNumber(phone) {
  if (!phone) return '';
  const clean = phone.replace(/\D/g, '');
  if (clean.length === 10) {
    return clean.replace(/(\d{2,3})(\d{3,4})(\d{4})/, '$1-$2-$3');
  } else if (clean.length === 11) {
    return clean.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
  } else {
    return phone;
  }
}

/////////////////////////////////////////////////////
// ‚úÖ Ï£ºÎ¨∏ Î≤àÌò∏ ÏÉùÏÑ±Í∏∞
/////////////////////////////////////////////////////
function generateOrderNumber() {
  const now = new Date();
  const MMDD = ("0" + (now.getMonth() + 1)).slice(-2) + ("0" + now.getDate()).slice(-2);
  const mmss = ("0" + now.getMinutes()).slice(-2) + ("0" + now.getSeconds()).slice(-2);
  const rand = Math.floor(10 + Math.random() * 90);
  return Number(MMDD + mmss + rand);
}

// ‚úÖ Ï£ºÎ¨∏ ÌôïÏ†ï Ï≤òÎ¶¨
function confirmOrder() {
  if (!cart.length) {
    alert("Ïû•Î∞îÍµ¨ÎãàÏóê ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.");
    return;
  }

  // ‚úÖ ÏÇ¨ÏóÖÏûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const businessNumber = document.getElementById("businessNumberDisplay").value.trim();
  const supplierName = document.getElementById("supplierName").value.trim();
  const supplierContact = document.getElementById("supplierContact").value.trim();
  const supplierAddress = document.getElementById("supplierAddress").value.trim();
  const supplierEmail = document.getElementById("supplierEmail").value.trim();
  const supplierZipcodeElement = document.getElementById("supplierZipcode");
  const remarksElement = document.getElementById("remarks");

  // ‚úÖ Null Ï∞∏Ï°∞ Î∞©ÏßÄ
  const supplierZipcode = supplierZipcodeElement ? supplierZipcodeElement.value.trim() : "";
  const remarks = remarksElement ? remarksElement.value.trim() : "";

  if (!businessNumber || !supplierName || !supplierContact || !supplierAddress) {
    alert("ÏÇ¨ÏóÖÏûê Ï†ïÎ≥¥Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  // ‚úÖ Ï£ºÎ¨∏ Ï†ïÎ≥¥ ÏÉùÏÑ±
  const orderId = generateOrderNumber();

  // ‚úÖ Ïû•Î∞îÍµ¨Îãà Ìï≠Î™© Ï†ïÎ¶¨
  const items = cart.map(item => ({
    code: item.code,
    name: item.name,
    qty: item.qty,
    price: item.price
  }));

  // ‚úÖ Ï¥ù Í∏àÏï° Í≥ÑÏÇ∞
  const total = items.reduce((sum, item) => sum + item.price * item.qty, 0);

  // ‚úÖ Payload ÏÉùÏÑ±
  const payload = {
    order_id: orderId,
    name: supplierName,
    phone: supplierContact,
    address: supplierAddress,
    email: supplierEmail,
    zipcode: supplierZipcode,
    remarks: remarks,
    items: JSON.stringify(items),
    total: total,
    created_at: new Date().toISOString(),
    business_registration_number: businessNumber,
    supplier: true
  };

  // ‚úÖ SupabaseÏóê Ï£ºÎ¨∏ Ï†ïÎ≥¥ Ï†ÄÏû•
  supabase.from('orders').insert([payload])
    .then(({ data, error }) => {
      if (error) {
        console.error("Ï£ºÎ¨∏ Ï†ÄÏû• Ïò§Î•ò:", error.message);
        alert("Ï£ºÎ¨∏ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§.");
        return;
      }
      alert(`Ï£ºÎ¨∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.\nÏ£ºÎ¨∏Î≤àÌò∏: ${orderId}`);
      // üöÄ ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (Ïû•Î∞îÍµ¨Îãà ÎπÑÏõÄ)
      location.reload();
    });
}

// ‚úÖ Î™®Îìà ÎÇ¥Î≥¥ÎÇ¥Í∏∞
export {
  searchProduct,
  toggleEdit,
  renderCart,
  removeItem,
  updateQty,
  calculateTotalWithShipping,
  confirmOrder,
  searchSupplier
};

