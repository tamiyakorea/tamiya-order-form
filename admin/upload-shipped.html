<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>배송 완료 주문 업로드</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://edgvrwekvnavkhcqwtxa.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZ3Zyd2Vrdm5hdmtoY3F3dHhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNDkzNTAsImV4cCI6MjA1OTgyNTM1MH0.Qg5zp-QZPFMcB1IsnxaCZMP7zh7fcrqY_6BV4hyp21E'
    );

    function generateOrderNumber() {
      const now = new Date();
      const MMDD = ("0" + (now.getMonth() + 1)).slice(-2) + ("0" + now.getDate()).slice(-2);
      const mmss = ("0" + now.getMinutes()).slice(-2) + ("0" + now.getSeconds()).slice(-2);
      const rand = Math.floor(10 + Math.random() * 90);
      return Number(MMDD + mmss + rand);
    }

    function parseItemsFromRow(row) {
      const items = [];
      for (let i = 1; i <= 10; i++) {
        const code = row[`serial_${i}`];
        const name = row[`product_name_${i}`];
        const qty = row[`qty_${i}`];
        const price = row[`price_${i}`];
        if (code && name && qty && price) {
          items.push({ code, name, qty: Number(qty), price: Number(price) });
        }
      }
      return items;
    }

    async function uploadExcel(event) {
      const file = event.target.files[0];
      if (!file) return alert("파일을 선택해주세요.");

      const reader = new FileReader();
      reader.onload = async (e) => {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const dataToUpload = rows.map(row => {
          const items = parseItemsFromRow(row);
          const total = items.reduce((sum, item) => sum + item.qty * item.price, 0);
          const order_id = row.order_id ? Number(row.order_id) : generateOrderNumber();

          return {
            order_id,
            name: row.customer_name,
            phone: row.phone,
            email: row.email || null,
            zipcode: row.zipcode ? String(row.zipcode) : '',
            address: row.address,
            address_detail: row.address_detail,
            receipt_info: row.receipt_info || null,
            tracking_number: row.tracking_number || null,
            shipping_note: row.shipping_note || null,
            remarks: row.remarks || null,
            items: JSON.stringify(items),
            total,
            is_ordered: true,
            is_shipped: true,
            is_delivered: true,
            created_at: new Date().toISOString()
          };
        });

        const { error } = await supabase.from('orders').insert(dataToUpload);
        if (error) {
          console.error(error);
          alert("업로드 실패: " + error.message);
        } else {
          alert("배송 완료 주문 업로드 완료!");
        }
      };
      reader.readAsBinaryString(file);
    }

    window.uploadExcel = uploadExcel;
  </script>
</head>
<body>
  <main style="max-width: 800px; margin: 30px auto; padding: 20px; font-family: sans-serif;">
    <h2>배송 완료 주문 엑셀 업로드</h2>
    <p>템플릿을 다운로드하고 작성한 뒤 업로드하세요.</p>
    <a href="/타미야_완료주문_업로드_템플릿.xlsx" download style="display:inline-block;margin-bottom:10px;">📄 템플릿 다운로드</a><br>
    <input type="file" accept=".xlsx,.xls" onchange="uploadExcel(event)" />
  </main>
</body>
</html>
