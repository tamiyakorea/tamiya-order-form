<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>í•œêµ­íƒ€ë¯¸ì•¼ ê°œë³„ì£¼ë¬¸ ì‹ ì²­</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 5px; }
    .section { margin-bottom: 30px; }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"], input[type="email"] {
      width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .total { font-weight: bold; }
    button { padding: 10px 20px; margin-top: 20px; cursor: pointer; font-size: 16px; }
    button.confirm {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    input.error { border: 1px solid red; }
    .error-container { display: flex; flex-direction: column; }
    .error-message { color: red; font-size: 0.9em; margin-top: 4px; opacity: 0; transition: opacity 0.3s ease, max-height 0.3s ease; max-height: 0; overflow: hidden; }
    .error-message.show { opacity: 1; max-height: 100px; }
    .button-search {
      width: fit-content; padding: 6px 12px; background: #f5f5f5;
      border: 1px solid #ccc; margin-top: 5px; transition: background 0.2s;
    }
    .button-search:hover { background: #eaeaea; }
    input.qty-input {
      width: 60px;
      text-align: center;
    }
  </style>
</head>
<body>
<h1>í•œêµ­íƒ€ë¯¸ì•¼ ê°œë³„ì£¼ë¬¸ ì‹ ì²­</h1>

<div class="section">
  <h2>ì‹ ì²­ ì „ ê³ ê° ì•ˆë‚´ì‚¬í•­</h2>
  <p>
    â€» ë¶€í’ˆ ì£¼ë¬¸ì€ êµ­ë‚´ì—ì„œ ìœ í†µ ì¤‘ì¸ ì œí’ˆì— í•œí•´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br />
    â€» ì£¼ë¬¸ í›„ ì·¨ì†ŒëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.<br />
    â€» ë¶€í’ˆì€ ì†Œìš” ê¸°ê°„ì´ ìˆìœ¼ë‹ˆ ì—¬ìœ ìˆê²Œ ì‹ ì²­ ë°”ëë‹ˆë‹¤.
  </p>
</div>

<h2>ê³ ê° ì •ë³´ ì…ë ¥</h2>
<label for="customerName">ì„±ëª…</label>
<div class="error-container">
  <input id="customerName" placeholder="í™ê¸¸ë™" type="text" />
</div>
<label for="phoneNumber">ì „í™”ë²ˆí˜¸</label>
<div class="error-container">
  <input id="phoneNumber" placeholder="010-1234-5678" type="text" />
</div>
<label for="email">ì´ë©”ì¼ ì£¼ì†Œ</label>
<div class="error-container">
  <input id="email" placeholder="example@example.com" type="email" />
</div>
<label for="zipcode">ìš°í¸ë²ˆí˜¸</label>
<div class="error-container">
  <input id="zipcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly type="text" />
  <button onclick="execDaumPostcode()" type="button" class="button-search">ê²€ìƒ‰</button>
</div>
<label for="address">ì£¼ì†Œ</label>
<div class="error-container">
  <input id="address" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly type="text" />
</div>
<label for="addressDetail">ìƒì„¸ì£¼ì†Œ</label>
<div class="error-container">
  <input id="addressDetail" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" type="text" />
</div>
<label style="margin-top: 15px;">
  <input id="receiptRequested" onchange="toggleCashReceipt()" type="checkbox" /> í˜„ê¸ˆì˜ìˆ˜ì¦ ì‹ ì²­
</label>
<div id="cashReceiptSection" style="display: none; margin-top: 10px;">
  <label for="receiptInfo">í˜„ê¸ˆì˜ìˆ˜ì¦ ì •ë³´ (íœ´ëŒ€í° ë²ˆí˜¸ ë˜ëŠ” ì‚¬ì—…ìë²ˆí˜¸)</label>
  <div class="error-container">
    <input id="receiptInfo" placeholder="010-1234-5678 ë˜ëŠ” 123-45-67890" type="text" />
  </div>
</div>

<div class="section">
  <h2>ì œí’ˆ ê²€ìƒ‰ ë° ì‹ ì²­</h2>
  <label for="serialSearch">ì œí’ˆ ì‹œë¦¬ì–¼ ë„˜ë²„ ì…ë ¥</label>
  <input id="serialSearch" placeholder="ì˜ˆ: 12345" type="text" />
  <button onclick="searchProduct()">ê²€ìƒ‰</button>
</div>

<div class="section">
  <h2>ì¥ë°”êµ¬ë‹ˆ</h2>
  <table id="cartTable" style="display:none;">
    <thead>
      <tr>
        <th>ì‹œë¦¬ì–¼</th>
        <th>ì œí’ˆëª…</th>
        <th>ë‹¨ê°€</th>
        <th>ìˆ˜ëŸ‰</th>
        <th>í•©ê³„</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody id="cartBody"></tbody>
    <tfoot>
      <tr class="total">
        <td colspan="4">ì´ ì£¼ë¬¸ê¸ˆì•¡</td>
        <td colspan="2" id="cartTotal">â‚©0</td>
      </tr>
    </tfoot>
  </table>
</div>

<div class="section">
  <h2>ì£¼ë¬¸ í™•ì • ì „ ì•ˆë‚´ ë° ì£¼ì˜ì‚¬í•­</h2>
  <p>
    â€» ì…ê¸ˆ ê³„ì¢ŒëŠ” ì£¼ë¬¸ í™•ì • ì‹œ ì œê³µë©ë‹ˆë‹¤.<br />
    â€» ë™ì¼ ì œí’ˆë„ ë¶€í’ˆë²ˆí˜¸ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ, ë°˜ë“œì‹œ ì •í™•í•œ ì‹œë¦¬ì–¼ ë„˜ë²„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br />
    â€» ê°€ê²©ì€ ë¶€ê°€ì„¸ í¬í•¨ ì†Œë¹„ì ê¸°ì¤€ì…ë‹ˆë‹¤.
  </p>
  <button onclick="confirmOrder()" class="confirm">âœ… ì£¼ë¬¸ í™•ì •</button>
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://edgvrwekvnavkhcqwtxa.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkZ3Zyd2Vrdm5hdmtoY3F3dHhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNDkzNTAsImV4cCI6MjA1OTgyNTM1MH0.Qg5zp-QZPFMcB1IsnxaCZMP7zh7fcrqY_6BV4hyp21E' // ì˜¬ë°”ë¥¸ anon í‚¤ë¡œ êµì²´í•˜ì„¸ìš”
  );

  const cart = [];

  function generateOrderNumber() {
    const now = new Date();
    const date = now.toISOString().slice(0, 10).replace(/-/g, '');
    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
    const rand = Math.floor(10 + Math.random() * 90);
    return Number(date + time + rand); // ì˜ˆ: 2025041110452382
  }

  async function searchProduct() {
    const serial = document.getElementById("serialSearch").value.trim();
    const serialNum = parseInt(serial, 10);
    if (isNaN(serialNum)) return;

    const { data, error } = await supabase
      .from('tamiya_items')
      .select('item_code, description, j_retail')
      .eq('item_code', serialNum)
      .single();

    if (!error && data) {
      const existing = cart.find(item => item.item_code === serialNum);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({
          item_code: data.item_code,
          description: data.description,
          price: Math.floor(data.j_retail * 15),
          qty: 1
        });
      }
      renderCart();
    }
  }

  function renderCart() {
    const tbody = document.getElementById("cartBody");
    const table = document.getElementById("cartTable");
    tbody.innerHTML = "";

    let subtotal = 0;
    cart.forEach((item, index) => {
      const rowTotal = item.price * item.qty;
      subtotal += rowTotal;

      tbody.innerHTML += `
        <tr>
          <td>${item.item_code}</td>
          <td>${item.description}</td>
          <td>â‚©${item.price.toLocaleString()}</td>
          <td><input type="number" class="qty-input" value="${item.qty}" min="1" onchange="updateQty(${index}, this.value)"></td>
          <td>â‚©${rowTotal.toLocaleString()}</td>
          <td><button onclick="removeItem(${index})">ì‚­ì œ</button></td>
        </tr>
      `;
    });

    const shipping = subtotal < 30000 ? 3000 : 0;
    const total = subtotal + shipping;

    tbody.innerHTML += `
      <tr class="total">
        <td colspan="4">ë°°ì†¡ë¹„</td>
        <td colspan="2">â‚©${shipping.toLocaleString()}</td>
      </tr>
    `;

    document.getElementById("cartTotal").textContent = `â‚©${total.toLocaleString()}`;
    table.style.display = cart.length ? "table" : "none";
  }

  function updateQty(index, newQty) {
    const qty = parseInt(newQty);
    if (qty > 0) {
      cart[index].qty = qty;
      renderCart();
    }
  }

  function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById('zipcode').value = data.zonecode;
        document.getElementById('address').value = data.roadAddress || data.jibunAddress;
      }
    }).open();
  }

  function toggleCashReceipt() {
    document.getElementById("cashReceiptSection").style.display =
      document.getElementById("receiptRequested").checked ? "block" : "none";
  }

  async function confirmOrder() {
  const get = id => document.getElementById(id);
  const name = get("customerName").value.trim();
  const phone = get("phoneNumber").value.trim();
  const email = get("email").value.trim();
  const zipcode = get("zipcode").value.trim();
  const address = get("address").value.trim();
  const addressDetail = get("addressDetail").value.trim();
  const receiptChecked = get("receiptRequested").checked;
  const receiptInfo = receiptChecked ? get("receiptInfo").value.trim() : null;

  if (!cart.length) {
    alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ì´ ê¸ˆì•¡ ê³„ì‚°
  let subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  const shipping = subtotal < 30000 ? 3000 : 0;
  const total = subtotal + shipping;

  // ì£¼ë¬¸ë²ˆí˜¸ ìƒì„± (ì—¬ê¸°ì„œ ìƒì„±ëœ ê°’ì„ Supabaseì— ì €ì¥í•  ê±°ì•¼)
  const orderId = generateOrderNumber();  // â† ì´ê±¸ DBì— ë„£ì„ ê±°ì•¼

  // ğŸ‘‡ ì—¬ê¸°! payload ì •ì˜
  const payload = {
    order_id: orderId,
    name,
    phone,
    email,
    zipcode,
    address,
    address_detail: addressDetail,
    receipt_info: receiptInfo,
    items: JSON.stringify(cart.map(item => ({
      code: item.item_code,
      name: item.description,
      qty: item.qty,
      price: item.price
    }))),
    total,
    created_at: new Date().toISOString()
  };

  // ğŸ‘‡ ì—¬ê¸°! Supabaseì— insert ìš”ì²­
  const { error } = await supabase.from("orders").insert(payload);

  if (error) {
    console.error("ì£¼ë¬¸ ì €ì¥ ì˜¤ë¥˜:", error);
    alert("ì£¼ë¬¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  } else {
    alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ë²ˆí˜¸: " + orderId);
    window.location.href = "payment-info.html?orderId=" + orderId;
  }
}
</script>
</body>
</html>
