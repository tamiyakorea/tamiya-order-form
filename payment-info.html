<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì…ê¸ˆ ì•ˆë‚´ ë° ì£¼ë¬¸ ì ˆì°¨</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="fonts/NanumGothic.js"></script>
  <script>
    pdfMake.vfs = { ...pdfMake.vfs, ...NanumGothicVFS };
    pdfMake.fonts = {
      NanumGothic: {
        normal: 'NanumGothic.ttf',
        bold: 'NanumGothic.ttf',
        italics: 'NanumGothic.ttf',
        bolditalics: 'NanumGothic.ttf'
      }
    };
  </script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">ê°œë³„ ì£¼ë¬¸ ì‹ ì²­</a></li>
      <li><a href="payment-info.html">ì…ê¸ˆ ì•ˆë‚´</a></li>
    </ul>
  </nav>

  <main>
    <h1>ì…ê¸ˆ ì•ˆë‚´</h1>
    <div class="section">
      <p>ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì…ê¸ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹  í›„,
      <span class="highlight">ì •í™•í•œ ê¸ˆì•¡ì„ ì…ê¸ˆí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</span></p>

      <h3>ğŸ’³ ì…ê¸ˆ ê³„ì¢Œ ì •ë³´</h3>
      <ul>
        <li>ì€í–‰ëª…: ì‹ í•œì€í–‰</li>
        <li>ê³„ì¢Œë²ˆí˜¸: 140-014-156630</li>
        <li>ì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼</li>
        <li>ì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´</li>
      </ul>
    </div>

    <div class="section">
      <h3>âš ï¸ ì£¼ë¬¸ ì§„í–‰ ì•ˆë‚´</h3>
      <ul>
        <li><span class="highlight">ì…ê¸ˆì´ ì™„ë£Œë˜ì–´ì•¼ ë¶€í’ˆ ì£¼ë¬¸ì´ ì§„í–‰ë©ë‹ˆë‹¤.</span></li>
        <li>ì…ê¸ˆ í™•ì¸ê¹Œì§€ ìµœëŒ€ 1~2 ì˜ì—…ì¼ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ì…ê¸ˆìëª…ê³¼ ì‹ ì²­ì ì •ë³´ê°€ ì¼ì¹˜í•´ì•¼ ì£¼ë¬¸ ì§„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li>ì£¼ë¬¸ í›„ ë³€ê²½ ë˜ëŠ” ì·¨ì†ŒëŠ” ë¶ˆê°€ëŠ¥í•˜ì˜¤ë‹ˆ, ì‹ ì¤‘íˆ í™•ì¸í•´ì£¼ì„¸ìš”.</li>
      </ul>
    </div>

    <div class="section">
      <h2>ğŸ§¾ ì£¼ë¬¸ì„œ</h2>
      <p>ì£¼ë¬¸ë²ˆí˜¸: <span class="highlight" id="orderId"></span></p>
      <p><strong>ì£¼ë¬¸ì¼ì‹œ:</strong> <span id="createdAt"></span></p>
      <p><strong>ì…ê¸ˆìƒíƒœ:</strong> <span id="paymentStatus"></span></p>
      <p><strong>ì…ê³ ì˜ˆì •:</strong> <span id="incomingDate"></span></p>

      <div id="orderResult">
        <p><strong>ê³ ê°ëª…:</strong> <span id="name"></span></p>
        <p><strong>ì—°ë½ì²˜:</strong> <span id="phone"></span></p>
        <p><strong>ì´ë©”ì¼:</strong> <span id="email"></span></p>
        <p><strong>ì£¼ì†Œ:</strong> <span id="address"></span></p>
      </div>

      <div id="orderTableContainer"></div>
    </div>

    <div class="btn-group">
      <button class="confirm" onclick="goHome()">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="confirm" onclick="downloadPDF()">PDFë¡œ ì €ì¥</button>
    </div>
  </main>

<footer style="width: 100%; background-color: #2b2b2f; color: #aaa; padding: 20px 0; font-size: 0.85em; line-height: 1.6;">
  <div style="max-width: 800px; margin: 0 auto; text-align: center;">
    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 15px; flex-wrap: wrap;">
      <img src="images/TamiyaPlamodelFactory.png" alt="í•œêµ­íƒ€ë¯¸ì•¼ ë¡œê³ " style="height: 80px; object-fit: contain;" />
      <div style="text-align: left; min-width: 250px;">
        <strong>TEL.</strong> 02-572-5353<br />
        í‰ì¼ ì˜¤ì „ 10:00 ~ ì˜¤í›„ 16:00<br />
        ì ì‹¬ì‹œê°„ ì˜¤í›„ 12:00 ~ ì˜¤í›„ 13:00<br />
        ì£¼ë§ ë° ê³µíœ´ì¼ íœ´ë¬´
      </div>
    </div>

    <div style="margin-top: 20px;">
      <div style="margin-bottom: 10px;">
        <strong>ìƒí˜¸</strong> : (ì£¼)í•œêµ­í‚¤ëœíŠ¸í•˜ë¹„ |
        <strong>ëŒ€í‘œì(ì„±ëª…)</strong> : ì•ˆì§„ì˜ |
        <strong>ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</strong> : 264-88-01483 |
        <strong>í†µì‹ íŒë§¤ì—… ì‹ ê³ </strong> : 2019-ì„œìš¸ì„œì´ˆ-1752 |
        <a href="https://www.ftc.go.kr/bizCommPop.do?wrkr_no=2648801483" target="_blank" style="color: #aaa; text-decoration: underline;">ì‚¬ì—…ì ì •ë³´ ì¡°íšŒ</a>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>ì „í™”</strong> : 02-572-5353 |
        <strong>íŒ©ìŠ¤</strong> : 02-572-1177 |
        <strong>ì£¼ì†Œ</strong> : ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°”ìš°ë«¼ë¡œ 215
      </div>
      <div style="margin-bottom: 10px;">
        <strong>ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì</strong> : (ì£¼)í•œêµ­í‚¤ëœíŠ¸í•˜ë¹„ | 
        <strong>E-mail ë¬¸ì˜</strong> : 
        <a href="mailto:webmaster@tamiya.co.kr" style="color: #aaa; text-decoration: underline;">webmaster@tamiya.co.kr</a>
      </div>
      <div style="margin-top: 10px;">
        copyright (c) kidult-hobby.co.kr all rights reserved.
      </div>
    </div>
  </div>
</footer>

<script>
const orderId = new URLSearchParams(window.location.search).get("orderId");
const orderIdEl = document.getElementById("orderId");
const nameEl = document.getElementById("name");
const phoneEl = document.getElementById("phone");
const emailEl = document.getElementById("email");
const addressEl = document.getElementById("address");
const tableContainer = document.getElementById("orderTableContainer");
const createdAtEl = document.getElementById("createdAt");
const paymentStatusEl = document.getElementById("paymentStatus");
const incomingDateEl = document.getElementById("incomingDate");

orderIdEl.textContent = orderId || "ì•Œ ìˆ˜ ì—†ìŒ";

let fetchedOrder = null;

// âœ… arrival_due ê³µí†µ ì²˜ë¦¬ í•¨ìˆ˜
function getArrivalDueText(items) {
  const arrivalDates = items
    .map(item => item.arrival_due && item.arrival_due.trim())
    .filter(date => !!date);
  const uniqueDates = [...new Set(arrivalDates)];
  return uniqueDates.length === 0 ? "ì§„í–‰ì¤‘" : uniqueDates.join(" / ");
}

// âœ… ì£¼ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function fetchOrder() {
  if (!orderId) return;
  const orderIdNumber = Number(orderId);
  try {
    const response = await fetch('https://edgvrwekvnavkhcqwtxa.supabase.co/functions/v1/get-order-by-id', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id: orderIdNumber })
    });
    const result = await response.json();
    const order = result.data;
    if (!response.ok || !order) {
      alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    fetchedOrder = order;

    nameEl.textContent = order.name || "-";
    phoneEl.textContent = order.phone || "-";
    emailEl.textContent = order.email || "-";
    addressEl.textContent = `${order.zipcode || ''} ${order.address || ''} ${order.address_detail || ''}`;
    createdAtEl.textContent = order.created_at ? order.created_at.split("T")[0] : "-";
    paymentStatusEl.textContent = order.payment_confirmed
      ? `í™•ì¸ë¨ (${order.payment_date ? order.payment_date.split("T")[0] : '-'})`
      : "ë¯¸í™•ì¸";

      let products = [];
    try {
      products = Array.isArray(order.items) ? order.items : JSON.parse(order.items);
    } catch (e) {
      console.error("ìƒí’ˆ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:", e);
    }

    // âœ… ì…ê³ ì˜ˆì • ì „ì²´ í‘œì‹œ (í—¤ë”ì˜ incomingDate)
    incomingDateEl.textContent = getArrivalDueText(products);

    if (products.length > 0) {
      let totalQty = 0;
      let totalItemsPrice = 0;
      let html = `<table><thead>
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ë‹¨ê°€</th>
          <th>í•©ê³„</th>
          <th>ì…ê³ ì˜ˆì •</th> <!-- âœ… ì¶”ê°€ -->
        </tr></thead><tbody>`;

      products.forEach(item => {
        const name = item.name || '-';
        const qty = Number(item.qty || 0);
        const price = Number(item.price || 0);
        const itemTotal = qty * price;
        const arrivalDue = item.arrival_due && item.arrival_due.trim() !== ""
          ? item.arrival_due
          : "ì§„í–‰ì¤‘"; // âœ… ì…ê³ ì˜ˆì • í‘œì‹œ

        totalQty += qty;
        totalItemsPrice += itemTotal;
        html += `<tr>
          <td>${name}</td>
          <td>${qty}</td>
          <td>${price.toLocaleString()}ì›</td>
          <td>${itemTotal.toLocaleString()}ì›</td>
          <td>${arrivalDue}</td> <!-- âœ… ì…ê³ ì˜ˆì • -->
        </tr>`;
      });

      const totalAmount = Number(order.total || 0);
      const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);
      html += `<tr><td colspan="4" style="text-align:right;"><strong>ë°°ì†¡ë¹„</strong></td><td>${shippingFee.toLocaleString()}ì›</td></tr>`;
      html += `<tr class="total"><td>ì´ê³„</td><td>${totalQty}</td><td></td><td>${totalAmount.toLocaleString()}ì›</td><td></td></tr>`;
      html += "</tbody></table>";
      tableContainer.innerHTML = html;
    } else {
      tableContainer.innerHTML = "<p>ì£¼ë¬¸ ìƒí’ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    }
  } catch (error) {
    console.error("ì¡°íšŒ ì˜¤ë¥˜:", error);
    alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

fetchOrder();

  function goHome() {
  window.location.href = "https://tamiyakorea.github.io/tamiya-order-form/";
}

// âœ… PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadPDF() {
  if (!fetchedOrder) {
    alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const products = Array.isArray(fetchedOrder.items) ? fetchedOrder.items : JSON.parse(fetchedOrder.items);
  const itemsTable = products.map(item => [
    item.name || "-",
    String(item.qty || 0),
    (item.price || 0).toLocaleString() + "ì›",
    ((item.qty || 0) * (item.price || 0)).toLocaleString() + "ì›",
    item.arrival_due && item.arrival_due.trim() !== "" ? item.arrival_due : "ì§„í–‰ì¤‘"
  ]);

  const totalAmount = Number(fetchedOrder.total || 0);
  const totalQty = products.reduce((sum, item) => sum + Number(item.qty || 0), 0);
  const totalItemsPrice = products.reduce((sum, item) => sum + (item.qty || 0) * (item.price || 0), 0);
  const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);
  const arrivalDueText = getArrivalDueText(products);

  const docDefinition = {
    content: [
      { text: 'íƒ€ë¯¸ì•¼ ê°œë³„ ì£¼ë¬¸ì„œ', style: 'header', alignment: 'center' },
      { text: '\nì…ê¸ˆ ê³„ì¢Œ ì •ë³´', style: 'subheader' },
      'ì€í–‰ëª…: ì‹ í•œì€í–‰\nê³„ì¢Œë²ˆí˜¸: 140-014-156630\nì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼\nì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´',
      { text: '\nê³ ê° ì •ë³´', style: 'subheader' },
      `ê³ ê°ëª…: ${fetchedOrder.name}\nì—°ë½ì²˜: ${fetchedOrder.phone}\nì´ë©”ì¼: ${fetchedOrder.email}\nì£¼ì†Œ: ${fetchedOrder.zipcode} ${fetchedOrder.address} ${fetchedOrder.address_detail}`,
      { text: `ì£¼ë¬¸ë²ˆí˜¸: ${fetchedOrder.order_id}\nì£¼ë¬¸ì¼ì‹œ: ${fetchedOrder.created_at ? fetchedOrder.created_at.split("T")[0] : "-"}\nì…ê¸ˆìƒíƒœ: ${fetchedOrder.payment_confirmed ? `í™•ì¸ë¨ (${fetchedOrder.payment_date ? fetchedOrder.payment_date.split("T")[0] : '-'})` : "ë¯¸í™•ì¸"}\nì…ê³ ì˜ˆì •: ${arrivalDueText}`, style: 'subheader' },
      {
        style: 'tableExample',
        table: {
          headerRows: 1,
          widths: ['*', 'auto', 'auto', 'auto', 'auto'],
          body: [
            ['ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'í•©ê³„', 'ì…ê³ ì˜ˆì •'],
            ...itemsTable,
            [{ text: 'ë°°ì†¡ë¹„', colSpan: 4, alignment: 'right' }, {}, {}, {}, `${shippingFee.toLocaleString()}ì›`],
            [{ text: 'ì´ê³„', colSpan: 2, alignment: 'right' }, {}, `${totalQty}`, `${totalAmount.toLocaleString()}ì›`, '']
          ]
        },
        layout: 'lightHorizontalLines'
      }
    ],
    styles: {
      header: { fontSize: 18, bold: true, margin: [0, 10, 0, 10] },
      subheader: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] },
      tableExample: { margin: [0, 5, 0, 15] },
    },
    defaultStyle: { font: 'NanumGothic' }
  };

  pdfMake.createPdf(docDefinition).download(`tamiya_order_${orderId || 'receipt'}.pdf`);
}
</script>
</body>
</html>
