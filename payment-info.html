<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì…ê¸ˆ ì•ˆë‚´ ë° ì£¼ë¬¸ ì ˆì°¨</title>
  <link rel="stylesheet" href="styles.css">
  <!-- âœ… pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">ê°œë³„ ì£¼ë¬¸ ì‹ ì²­</a></li>
      <li><a href="payment-info.html">ì…ê¸ˆ ì•ˆë‚´</a></li>
    </ul>
  </nav>

  <main>
    <h1>ì…ê¸ˆ ì•ˆë‚´</h1>

    <div class="section">
      <p>ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì…ê¸ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹  í›„,</p>
      <p><span class="highlight">ì •í™•í•œ ê¸ˆì•¡ì„ ì…ê¸ˆí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</span></p>

      <h3>ğŸ’³ ì…ê¸ˆ ê³„ì¢Œ ì •ë³´</h3>
      <ul>
        <li>ì€í–‰ëª…: ì‹ í•œì€í–‰</li>
        <li>ê³„ì¢Œë²ˆí˜¸: 140-014-156630</li>
        <li>ì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼</li>
        <li>ì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´</li>
      </ul>
    </div>

    <div class="section">
      <h3>âš ï¸ ì£¼ë¬¸ ì§„í–‰ ì•ˆë‚´</h3>
      <ul>
        <li><span class="highlight">ì…ê¸ˆì´ ì™„ë£Œë˜ì–´ì•¼ ë¶€í’ˆ ì£¼ë¬¸ì´ ì§„í–‰</span>ë©ë‹ˆë‹¤.</li>
        <li>ì…ê¸ˆ í™•ì¸ê¹Œì§€ ìµœëŒ€ 1~2 ì˜ì—…ì¼ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ì…ê¸ˆìëª…ê³¼ ì‹ ì²­ì ì •ë³´ê°€ ì¼ì¹˜í•´ì•¼ ì£¼ë¬¸ ì§„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li>ì£¼ë¬¸ í›„ ë³€ê²½ ë˜ëŠ” ì·¨ì†ŒëŠ” ë¶ˆê°€ëŠ¥í•˜ì˜¤ë‹ˆ, ì‹ ì¤‘íˆ í™•ì¸í•´ì£¼ì„¸ìš”.</li>
      </ul>
    </div>

    <div class="section">
      <h2>ğŸ§¾ ì£¼ë¬¸ì„œ</h2>
      <p>ì£¼ë¬¸ë²ˆí˜¸: <span class="highlight" id="orderId"></span></p>

      <div id="orderResult">
        <p><strong>ê³ ê°ëª…:</strong> <span id="name"></span></p>
        <p><strong>ì—°ë½ì²˜:</strong> <span id="phone"></span></p>
        <p><strong>ì´ë©”ì¼:</strong> <span id="email"></span></p>
        <p><strong>ì£¼ì†Œ:</strong> <span id="address"></span></p>
      </div>

      <div id="orderTableContainer"></div>
    </div>

    <div class="btn-group">
      <button class="confirm" onclick="goHome()">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="confirm" onclick="downloadPDF()">PDFë¡œ ì €ì¥</button>
    </div>
  </main>

  <footer>
    <div style="text-align:center;">
      <p>Â© 2025 í•œêµ­íƒ€ë¯¸ì•¼ | ë³¸ í˜ì´ì§€ì˜ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­íƒ€ë¯¸ì•¼ì— ì €ì‘ê¶Œì´ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
  </footer>

  <script>
    const orderId = new URLSearchParams(window.location.search).get("orderId");
    const orderIdEl = document.getElementById("orderId");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const emailEl = document.getElementById("email");
    const addressEl = document.getElementById("address");
    const tableContainer = document.getElementById("orderTableContainer");

    orderIdEl.textContent = orderId || "ì•Œ ìˆ˜ ì—†ìŒ";

    let fetchedOrder = null;

    async function fetchOrder() {
      if (!orderId) return;
      const orderIdNumber = Number(orderId);
      try {
        const response = await fetch('https://edgvrwekvnavkhcqwtxa.supabase.co/functions/v1/get-order-by-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderIdNumber })
        });
        const result = await response.json();
        const order = result.data;
        if (!response.ok || !order) {
          alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        fetchedOrder = order; // ğŸ‘‰ pdf ë‹¤ìš´ë¡œë“œìš©ìœ¼ë¡œ ì €ì¥

        nameEl.textContent = order.name || "-";
        phoneEl.textContent = order.phone || "-";
        emailEl.textContent = order.email || "-";
        addressEl.textContent = `${order.zipcode || ''} ${order.address || ''} ${order.address_detail || ''}`;

        let products = [];
        try {
          products = Array.isArray(order.items) ? order.items : JSON.parse(order.items);
        } catch (e) {
          console.error("ìƒí’ˆ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:", e);
        }

        if (products.length > 0) {
          let totalQty = 0;
          let totalItemsPrice = 0;
          let html = `<table><thead><tr><th>ìƒí’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>í•©ê³„</th></tr></thead><tbody>`;
          products.forEach(item => {
            const name = item.name || '-';
            const qty = Number(item.qty || 0);
            const price = Number(item.price || 0);
            const itemTotal = qty * price;
            totalQty += qty;
            totalItemsPrice += itemTotal;
            html += `<tr><td>${name}</td><td>${qty}</td><td>${price.toLocaleString()}ì›</td><td>${itemTotal.toLocaleString()}ì›</td></tr>`;
          });
          const totalAmount = Number(order.total || 0);
          const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);
          html += `<tr><td colspan="3" style="text-align:right;"><strong>ë°°ì†¡ë¹„</strong></td><td>${shippingFee.toLocaleString()}ì›</td></tr>`;
          html += `<tr class="total"><td>ì´ê³„</td><td>${totalQty}</td><td></td><td>${totalAmount.toLocaleString()}ì›</td></tr></tbody></table>`;
          tableContainer.innerHTML = html;
        } else {
          tableContainer.innerHTML = "<p>ì£¼ë¬¸ ìƒí’ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
      } catch (error) {
        console.error("ì¡°íšŒ ì˜¤ë¥˜:", error);
        alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    fetchOrder();

    function goHome() {
      window.location.href = "https://tamiyakorea.github.io/tamiya-order-form/";
    }

    function downloadPDF() {
  if (!fetchedOrder) {
    alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const products = Array.isArray(fetchedOrder.items) ? fetchedOrder.items : JSON.parse(fetchedOrder.items);
  const itemsTable = products.map(item => {
    return [
      item.name || "-",
      String(item.qty || 0),
      (item.price || 0).toLocaleString() + "ì›",
      ((item.qty || 0) * (item.price || 0)).toLocaleString() + "ì›"
    ];
  });

  const totalAmount = Number(fetchedOrder.total || 0);
  const totalQty = products.reduce((sum, item) => sum + Number(item.qty || 0), 0);
  const totalItemsPrice = products.reduce((sum, item) => sum + (item.qty || 0) * (item.price || 0), 0);
  const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);

  const docDefinition = {
    content: [
      { text: 'íƒ€ë¯¸ì•¼ ê°œë³„ ì£¼ë¬¸ì„œ', style: 'header', alignment: 'center' },
      { text: '\n[ì…ê¸ˆ ê³„ì¢Œ ì •ë³´]\nì€í–‰ëª…: ì‹ í•œì€í–‰\nê³„ì¢Œë²ˆí˜¸: 140-014-156630\nì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼\nì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´', style: 'subheader' },
      { text: '\n[ê³ ê° ì •ë³´]', style: 'subheader' },
      { text: `ê³ ê°ëª…: ${fetchedOrder.name}\nì—°ë½ì²˜: ${fetchedOrder.phone}\nì´ë©”ì¼: ${fetchedOrder.email}\nì£¼ì†Œ: ${fetchedOrder.zipcode} ${fetchedOrder.address} ${fetchedOrder.address_detail}`, margin: [0, 5, 0, 15] },
      {
        table: {
          headerRows: 1,
          widths: ['*', 'auto', 'auto', 'auto'],
          body: [
            ['ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'í•©ê³„'],
            ...itemsTable,
            [{ text: 'ë°°ì†¡ë¹„', colSpan: 3, alignment: 'right' }, {}, {}, `${shippingFee.toLocaleString()}ì›`],
            [{ text: 'ì´ê³„', colSpan: 2 }, {}, `${totalQty}`, `${totalAmount.toLocaleString()}ì›`]
          ]
        },
        layout: 'lightHorizontalLines'
      }
    ],
    styles: {
      header: { fontSize: 16, bold: true },
      subheader: { fontSize: 12, bold: true },
    },
    defaultStyle: {
      font: 'Roboto'  // âœ… ì—¬ê¸° ìˆ˜ì •
    }
  };

  pdfMake.createPdf(docDefinition).download(`tamiya_order_${orderId || 'receipt'}.pdf`);
}

  </script>
</body>
</html>
