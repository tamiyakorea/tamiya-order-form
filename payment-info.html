<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>입금 안내 및 주문 절차</title>
  <link rel="stylesheet" href="styles.css">
  <!-- ✅ pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">개별 주문 신청</a></li>
      <li><a href="payment-info.html">입금 안내</a></li>
    </ul>
  </nav>

  <main>
    <h1>입금 안내</h1>

    <div class="section">
      <p>주문이 정상적으로 접수되었습니다. 아래 입금 정보를 확인하신 후,</p>
      <p><span class="highlight">정확한 금액을 입금해주시기 바랍니다.</span></p>

      <h3>💳 입금 계좌 정보</h3>
      <ul>
        <li>은행명: 신한은행</li>
        <li>계좌번호: 140-014-156630</li>
        <li>예금주: (주)한국타미야</li>
        <li>입금기한: 신청일로부터 3일 이내</li>
      </ul>
    </div>

    <div class="section">
      <h3>⚠️ 주문 진행 안내</h3>
      <ul>
        <li><span class="highlight">입금이 완료되어야 부품 주문이 진행</span>됩니다.</li>
        <li>입금 확인까지 최대 1~2 영업일이 소요될 수 있습니다.</li>
        <li>입금자명과 신청자 정보가 일치해야 주문 진행이 가능합니다.</li>
        <li>주문 후 변경 또는 취소는 불가능하오니, 신중히 확인해주세요.</li>
      </ul>
    </div>

    <div class="section">
      <h2>🧾 주문서</h2>
      <p>주문번호: <span class="highlight" id="orderId"></span></p>

      <div id="orderResult">
        <p><strong>고객명:</strong> <span id="name"></span></p>
        <p><strong>연락처:</strong> <span id="phone"></span></p>
        <p><strong>이메일:</strong> <span id="email"></span></p>
        <p><strong>주소:</strong> <span id="address"></span></p>
      </div>

      <div id="orderTableContainer"></div>
    </div>

    <div class="btn-group">
      <button class="confirm" onclick="goHome()">홈으로 돌아가기</button>
      <button class="confirm" onclick="downloadPDF()">PDF로 저장</button>
    </div>
  </main>

  <footer>
    <div style="text-align:center;">
      <p>© 2025 한국타미야 | 본 페이지의 모든 내용은 한국타미야에 저작권이 있습니다.</p>
    </div>
  </footer>

  <script>
    const orderId = new URLSearchParams(window.location.search).get("orderId");
    const orderIdEl = document.getElementById("orderId");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const emailEl = document.getElementById("email");
    const addressEl = document.getElementById("address");
    const tableContainer = document.getElementById("orderTableContainer");

    orderIdEl.textContent = orderId || "알 수 없음";

    let fetchedOrder = null;

    async function fetchOrder() {
      if (!orderId) return;
      const orderIdNumber = Number(orderId);
      try {
        const response = await fetch('https://edgvrwekvnavkhcqwtxa.supabase.co/functions/v1/get-order-by-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderIdNumber })
        });
        const result = await response.json();
        const order = result.data;
        if (!response.ok || !order) {
          alert("주문 정보를 불러올 수 없습니다.");
          return;
        }
        fetchedOrder = order; // 👉 pdf 다운로드용으로 저장

        nameEl.textContent = order.name || "-";
        phoneEl.textContent = order.phone || "-";
        emailEl.textContent = order.email || "-";
        addressEl.textContent = `${order.zipcode || ''} ${order.address || ''} ${order.address_detail || ''}`;

        let products = [];
        try {
          products = Array.isArray(order.items) ? order.items : JSON.parse(order.items);
        } catch (e) {
          console.error("상품 정보 파싱 오류:", e);
        }

        if (products.length > 0) {
          let totalQty = 0;
          let totalItemsPrice = 0;
          let html = `<table><thead><tr><th>상품명</th><th>수량</th><th>단가</th><th>합계</th></tr></thead><tbody>`;
          products.forEach(item => {
            const name = item.name || '-';
            const qty = Number(item.qty || 0);
            const price = Number(item.price || 0);
            const itemTotal = qty * price;
            totalQty += qty;
            totalItemsPrice += itemTotal;
            html += `<tr><td>${name}</td><td>${qty}</td><td>${price.toLocaleString()}원</td><td>${itemTotal.toLocaleString()}원</td></tr>`;
          });
          const totalAmount = Number(order.total || 0);
          const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);
          html += `<tr><td colspan="3" style="text-align:right;"><strong>배송비</strong></td><td>${shippingFee.toLocaleString()}원</td></tr>`;
          html += `<tr class="total"><td>총계</td><td>${totalQty}</td><td></td><td>${totalAmount.toLocaleString()}원</td></tr></tbody></table>`;
          tableContainer.innerHTML = html;
        } else {
          tableContainer.innerHTML = "<p>주문 상품 내역이 없습니다.</p>";
        }
      } catch (error) {
        console.error("조회 오류:", error);
        alert("조회 중 오류가 발생했습니다.");
      }
    }

    fetchOrder();

    function goHome() {
      window.location.href = "https://tamiyakorea.github.io/tamiya-order-form/";
    }

    function downloadPDF() {
  if (!fetchedOrder) {
    alert("주문 정보를 불러오지 못했습니다.");
    return;
  }

  const products = Array.isArray(fetchedOrder.items) ? fetchedOrder.items : JSON.parse(fetchedOrder.items);
  const itemsTable = products.map(item => {
    return [
      item.name || "-",
      String(item.qty || 0),
      (item.price || 0).toLocaleString() + "원",
      ((item.qty || 0) * (item.price || 0)).toLocaleString() + "원"
    ];
  });

  const totalAmount = Number(fetchedOrder.total || 0);
  const totalQty = products.reduce((sum, item) => sum + Number(item.qty || 0), 0);
  const totalItemsPrice = products.reduce((sum, item) => sum + (item.qty || 0) * (item.price || 0), 0);
  const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);

  const docDefinition = {
    content: [
      { text: '타미야 개별 주문서', style: 'header', alignment: 'center' },
      { text: '\n[입금 계좌 정보]\n은행명: 신한은행\n계좌번호: 140-014-156630\n예금주: (주)한국타미야\n입금기한: 신청일로부터 3일 이내', style: 'subheader' },
      { text: '\n[고객 정보]', style: 'subheader' },
      { text: `고객명: ${fetchedOrder.name}\n연락처: ${fetchedOrder.phone}\n이메일: ${fetchedOrder.email}\n주소: ${fetchedOrder.zipcode} ${fetchedOrder.address} ${fetchedOrder.address_detail}`, margin: [0, 5, 0, 15] },
      {
        table: {
          headerRows: 1,
          widths: ['*', 'auto', 'auto', 'auto'],
          body: [
            ['상품명', '수량', '단가', '합계'],
            ...itemsTable,
            [{ text: '배송비', colSpan: 3, alignment: 'right' }, {}, {}, `${shippingFee.toLocaleString()}원`],
            [{ text: '총계', colSpan: 2 }, {}, `${totalQty}`, `${totalAmount.toLocaleString()}원`]
          ]
        },
        layout: 'lightHorizontalLines'
      }
    ],
    styles: {
      header: { fontSize: 16, bold: true },
      subheader: { fontSize: 12, bold: true },
    },
    defaultStyle: {
      font: 'Roboto'  // ✅ 여기 수정
    }
  };

  pdfMake.createPdf(docDefinition).download(`tamiya_order_${orderId || 'receipt'}.pdf`);
}

  </script>
</body>
</html>
