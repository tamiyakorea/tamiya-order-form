<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì…ê¸ˆ ì•ˆë‚´ ë° ì£¼ë¬¸ ì ˆì°¨</title>
  <link rel="stylesheet" href="styles.css">
  <!-- âœ… jsPDF ë¨¼ì € ë¡œë“œ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- âœ… VFS í°íŠ¸ íŒŒì¼ ë¡œë“œ (Base64 í¬í•¨) -->
  <script src="fonts/NanumMyeongjo.js"></script>
  <script src="fonts/NanumMyeongjoBold.js"></script>
  <script src="fonts/NanumMyeongjoExtraBold.js"></script>

  <!-- âœ… jsPDF ë¡œë“œ í›„ í°íŠ¸ ë“±ë¡ ìˆœì„œ ë³´ì¥ -->
  <script>
    window.addEventListener('load', function() {
      const { jsPDF } = window.jspdf;
      if (typeof jsPDF !== "undefined") {
  jsPDF.API.events.push(["addFonts", function() {
    this.addFileToVFS("NanumMyeongjo.ttf", NanumMyeongjo);
    this.addFont("NanumMyeongjo.ttf", "NanumMyeongjo", "normal"); // normal ìŠ¤íƒ€ì¼ ë“±ë¡
    this.addFont("NanumMyeongjo.ttf", "NanumMyeongjo", "Regular"); // Regularë„ ê°™ì´ ë“±ë¡
    this.addFont("NanumMyeongjo.ttf", "NanumMyeongjo", "");        // ë¹ˆ ë¬¸ìì—´ë„ ë“±ë¡
  }]);
  jsPDF.API.events.push(["addFonts", function() {
    this.addFileToVFS("NanumMyeongjoBold.ttf", NanumMyeongjoBold);
    this.addFont("NanumMyeongjoBold.ttf", "NanumMyeongjo", "bold"); // bold
    this.addFont("NanumMyeongjoBold.ttf", "NanumMyeongjo", "Bold"); // Bold
  }]);
  jsPDF.API.events.push(["addFonts", function() {
    this.addFileToVFS("NanumMyeongjoExtraBold.ttf", NanumMyeongjoExtraBold);
    this.addFont("NanumMyeongjoExtraBold.ttf", "NanumMyeongjo", "extra-bold"); // extra-bold
    this.addFont("NanumMyeongjoExtraBold.ttf", "NanumMyeongjo", "ExtraBold");  // ExtraBold
    this.addFont("NanumMyeongjoExtraBold.ttf", "NanumMyeongjo", "Black");      // Blackë„ ì‹œë„
  }]);
}
    });
  </script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">ê°œë³„ ì£¼ë¬¸ ì‹ ì²­</a></li>
      <li><a href="payment-info.html">ì…ê¸ˆ ì•ˆë‚´</a></li>
    </ul>
  </nav>

  <main>
    <h1>ì…ê¸ˆ ì•ˆë‚´</h1>

    <div class="section">
      <p>ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì…ê¸ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ì‹  í›„,</p>
      <p><span class="highlight">ì •í™•í•œ ê¸ˆì•¡ì„ ì…ê¸ˆí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</span></p>

      <h3>ğŸ’³ ì…ê¸ˆ ê³„ì¢Œ ì •ë³´</h3>
      <ul>
        <li>ì€í–‰ëª…: ì‹ í•œì€í–‰</li>
        <li>ê³„ì¢Œë²ˆí˜¸: 140-014-156630</li>
        <li>ì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼</li>
        <li>ì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´</li>
      </ul>
    </div>

    <div class="section">
      <h3>âš ï¸ ì£¼ë¬¸ ì§„í–‰ ì•ˆë‚´</h3>
      <ul>
        <li><span class="highlight">ì…ê¸ˆì´ ì™„ë£Œë˜ì–´ì•¼ ë¶€í’ˆ ì£¼ë¬¸ì´ ì§„í–‰</span>ë©ë‹ˆë‹¤.</li>
        <li>ì…ê¸ˆ í™•ì¸ê¹Œì§€ ìµœëŒ€ 1~2 ì˜ì—…ì¼ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ì…ê¸ˆìëª…ê³¼ ì‹ ì²­ì ì •ë³´ê°€ ì¼ì¹˜í•´ì•¼ ì£¼ë¬¸ ì§„í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li>ì£¼ë¬¸ í›„ ë³€ê²½ ë˜ëŠ” ì·¨ì†ŒëŠ” ë¶ˆê°€ëŠ¥í•˜ì˜¤ë‹ˆ, ì‹ ì¤‘íˆ í™•ì¸í•´ì£¼ì„¸ìš”.</li>
      </ul>
    </div>

    <div class="section">
      <h2>ğŸ§¾ ì£¼ë¬¸ì„œ</h2>
      <p>ì£¼ë¬¸ë²ˆí˜¸: <span class="highlight" id="orderId"></span></p>

      <div id="orderResult">
        <p><strong>ê³ ê°ëª…:</strong> <span id="name"></span></p>
        <p><strong>ì—°ë½ì²˜:</strong> <span id="phone"></span></p>
        <p><strong>ì´ë©”ì¼:</strong> <span id="email"></span></p>
        <p><strong>ì£¼ì†Œ:</strong> <span id="address"></span></p>
      </div>

      <div id="orderTableContainer"></div>
    </div>

    <div class="btn-group">
      <button class="confirm" onclick="goHome()">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="confirm" onclick="downloadPDF()">PDFë¡œ ì €ì¥</button>
    </div>
  </main>

  <footer>
    <div style="text-align:center;">
      <p>Â© 2025 í•œêµ­íƒ€ë¯¸ì•¼ | ë³¸ í˜ì´ì§€ì˜ ëª¨ë“  ë‚´ìš©ì€ í•œêµ­íƒ€ë¯¸ì•¼ì— ì €ì‘ê¶Œì´ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
  </footer>

  <script>
    const orderId = new URLSearchParams(window.location.search).get("orderId");
    const orderIdEl = document.getElementById("orderId");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const emailEl = document.getElementById("email");
    const addressEl = document.getElementById("address");
    const tableContainer = document.getElementById("orderTableContainer");

    orderIdEl.textContent = orderId || "ì•Œ ìˆ˜ ì—†ìŒ";

    async function fetchOrder() {
      if (!orderId) return;
      const orderIdNumber = Number(orderId);
      try {
        const response = await fetch('https://edgvrwekvnavkhcqwtxa.supabase.co/functions/v1/get-order-by-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderIdNumber })
        });
        const result = await response.json();
        const order = result.data;
        if (!response.ok || !order) {
          alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        nameEl.textContent = order.name || "-";
        phoneEl.textContent = order.phone || "-";
        emailEl.textContent = order.email || "-";
        addressEl.textContent = `${order.zipcode || ''} ${order.address || ''} ${order.address_detail || ''}`;

        let products = [];
        try {
          products = Array.isArray(order.items) ? order.items : JSON.parse(order.items);
        } catch (e) {
          console.error("ìƒí’ˆ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:", e);
        }

        if (products.length > 0) {
          let totalQty = 0;
          let totalItemsPrice = 0;
          let html = `<table><thead><tr><th>ìƒí’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>í•©ê³„</th></tr></thead><tbody>`;
          products.forEach(item => {
            const name = item.name || '-';
            const qty = Number(item.qty || 0);
            const price = Number(item.price || 0);
            const itemTotal = qty * price;
            totalQty += qty;
            totalItemsPrice += itemTotal;
            html += `<tr><td>${name}</td><td>${qty}</td><td>${price.toLocaleString()}ì›</td><td>${itemTotal.toLocaleString()}ì›</td></tr>`;
          });
          const totalAmount = Number(order.total || 0);
          const shippingFee = Math.max(totalAmount - totalItemsPrice, 0);
          html += `<tr><td colspan="3" style="text-align:right;"><strong>ë°°ì†¡ë¹„</strong></td><td>${shippingFee.toLocaleString()}ì›</td></tr>`;
          html += `<tr class="total"><td>ì´ê³„</td><td>${totalQty}</td><td></td><td>${totalAmount.toLocaleString()}ì›</td></tr></tbody></table>`;
          tableContainer.innerHTML = html;
        } else {
          tableContainer.innerHTML = "<p>ì£¼ë¬¸ ìƒí’ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
      } catch (error) {
        console.error("ì¡°íšŒ ì˜¤ë¥˜:", error);
        alert("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    fetchOrder();

    function goHome() {
      window.location.href = "https://tamiyakorea.github.io/tamiya-order-form/";
    }

    function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

  console.log(doc.getFontList());

      // âœ… ì œëª©ì€ ExtraBold
      doc.setFont("NanumMyeongjo", "extra-bold");
      doc.setFontSize(16);
      const orderTitle = 'íƒ€ë¯¸ì•¼ ê°œë³„ ì£¼ë¬¸ì„œ';
      doc.text(orderTitle, 105, 20, { align: 'center' });

      // âœ… ê³„ì¢Œ ì •ë³´ëŠ” Bold
      doc.setFont("NanumMyeongjo", "bold");
      doc.setFontSize(10);
      const bankInfo = `[ì…ê¸ˆ ê³„ì¢Œ ì •ë³´]\nì€í–‰ëª…: ì‹ í•œì€í–‰\nê³„ì¢Œë²ˆí˜¸: 140-014-156630\nì˜ˆê¸ˆì£¼: (ì£¼)í•œêµ­íƒ€ë¯¸ì•¼\nì…ê¸ˆê¸°í•œ: ì‹ ì²­ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´`;
      doc.text(bankInfo, 15, 35);

      // âœ… ê³ ê° ì •ë³´ëŠ” Normal
      doc.setFont("NanumMyeongjo", "normal");
      const customerInfo = `[ê³ ê° ì •ë³´]\nê³ ê°ëª…: ${nameEl.textContent}\nì—°ë½ì²˜: ${phoneEl.textContent}\nì´ë©”ì¼: ${emailEl.textContent}\nì£¼ì†Œ: ${addressEl.textContent}`;
      doc.text(customerInfo, 15, 70);

      const rows = [];
      const products = Array.from(document.querySelectorAll('#orderTableContainer tbody tr'));
      products.forEach(row => {
        const cols = row.querySelectorAll('td');
        if (cols.length === 4) {
          rows.push([
            cols[0].innerText.trim(),
            cols[1].innerText.trim(),
            cols[2].innerText.trim(),
            cols[3].innerText.trim()
          ]);
        }
      });

      // âœ… í‘œ ë³¸ë¬¸ì€ Normal
      doc.autoTable({
        startY: 100,
        head: [['ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'í•©ê³„']],
        body: rows,
        theme: 'grid',
        styles: { fontSize: 9, font: 'NanumMyeongjo' },
        headStyles: { fillColor: [41, 128, 185] },
        margin: { left: 15, right: 15 },
        didDrawPage: (data) => {
          doc.setFontSize(8);
          doc.text(`í˜ì´ì§€ ${doc.internal.getNumberOfPages()}`, 200, 290, { align: 'right' });
        }
      });

      doc.save(`tamiya_order_${orderId || 'receipt'}.pdf`);
    }
  </script>
</body>
</html>
