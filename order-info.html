<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ë¬¸ ì§„í–‰ í˜„í™©</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div style="text-align: center; padding: 10px 0; background-color: white;">
    <img src="images/logo.png" alt="í•œêµ­íƒ€ë¯¸ì•¼ ë¡œê³ " style="height: 90px;" />
  </div>

  <main>
    <h1>ì£¼ë¬¸ ì§„í–‰ í˜„í™©</h1>

    <div class="section">
      <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> <span id="orderId">-</span></p>
      <p><strong>ì£¼ë¬¸ì¼ì‹œ:</strong> <span id="createdAt">-</span></p>
      <p><strong>ì…ê¸ˆìƒíƒœ:</strong> <span id="paymentStatus">-</span></p>
      <p><strong>ì…ê³ ì˜ˆì •:</strong> <span id="incomingDate">-</span></p>
    </div>
    <div id="confirmationNoteContainer"></div>
        
    <div class="section">
      <h2>ê³ ê° ì •ë³´</h2>
      <p><strong>ì„±ëª…:</strong> <span id="name">-</span></p>
      <p><strong>ì „í™”ë²ˆí˜¸:</strong> <span id="phone">-</span></p>
      <p><strong>ì´ë©”ì¼:</strong> <span id="email">-</span></p>
      <p><strong>ì£¼ì†Œ:</strong> <span id="address">-</span></p>
      <p><strong>í˜„ê¸ˆì˜ìˆ˜ì¦ ì •ë³´:</strong> <span id="receiptInfo">-</span></p>
      <p><strong>ì†¡ì¥ë²ˆí˜¸(í•œì§„íƒë°°):</strong> <span id="tracking_number">-</span></p>
    </div>

    <div class="section">
      <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
      <div style="text-align: right; color: red;">ì…ê³  ë‚ ì§œëŠ” ìƒí™©(ê¸°í›„ ë° ì„ ë°• ìŠ¤ì¼€ì¥´)ì— ë”°ë¼ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      <div id="orderTableContainer"></div>
    </div>
  </main>

  <footer style="width: 100%; background-color: #2b2b2f; color: #aaa; padding: 20px 0; font-size: 0.85em; line-height: 1.6;">
  <div style="max-width: 800px; margin: 0 auto; text-align: center;">
    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 15px; flex-wrap: wrap;">
      <img src="images/TamiyaPlamodelFactory.png" alt="í•œêµ­íƒ€ë¯¸ì•¼ ë¡œê³ " style="height: 80px; object-fit: contain;" />
      <div style="text-align: left; min-width: 250px;">
        <strong>TEL.</strong> 02-572-5353<br />
        í‰ì¼ ì˜¤ì „ 10:00 ~ ì˜¤í›„ 16:00<br />
        ì ì‹¬ì‹œê°„ ì˜¤í›„ 12:00 ~ ì˜¤í›„ 13:00<br />
        ì£¼ë§ ë° ê³µíœ´ì¼ íœ´ë¬´
      </div>
    </div>

    <div style="margin-top: 20px;">
      <div style="margin-bottom: 10px;">
        <strong>ìƒí˜¸</strong> : (ì£¼)í•œêµ­í‚¤ëœíŠ¸í•˜ë¹„ |
        <strong>ëŒ€í‘œì(ì„±ëª…)</strong> : ì•ˆì§„ì˜ |
        <strong>ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</strong> : 264-88-01483 |
        <strong>í†µì‹ íŒë§¤ì—… ì‹ ê³ </strong> : 2019-ì„œìš¸ì„œì´ˆ-1752 |
        <a href="https://www.ftc.go.kr/bizCommPop.do?wrkr_no=2648801483" target="_blank" style="color: #aaa; text-decoration: underline;">ì‚¬ì—…ì ì •ë³´ ì¡°íšŒ</a>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>ì „í™”</strong> : 02-572-5353 |
        <strong>íŒ©ìŠ¤</strong> : 02-572-1177 |
        <strong>ì£¼ì†Œ</strong> : ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°”ìš°ë«¼ë¡œ 215
      </div>
      <div style="margin-bottom: 10px;">
        <strong>ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì</strong> : (ì£¼)í•œêµ­í‚¤ëœíŠ¸í•˜ë¹„ | 
        <strong>E-mail ë¬¸ì˜</strong> : 
        <a href="mailto:webmaster@tamiya.co.kr" style="color: #aaa; text-decoration: underline;">webmaster@tamiya.co.kr</a>
      </div>
      <div style="margin-top: 10px;">
        copyright (c) kidult-hobby.co.kr all rights reserved.
      </div>
    </div>
  </div>
</footer>

  <script>
    const orderId = new URLSearchParams(window.location.search).get("orderId");
    const el = id => document.getElementById(id);

async function fetchOrderInfo() {
  if (!orderId) return;

  try {
    const res = await fetch('https://edgvrwekvnavkhcqwtxa.supabase.co/functions/v1/get-order-by-id', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id: Number(orderId) })
    });

    const result = await res.json();
    if (!res.ok || !result.data) throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

    const order = result.data;
    const items = Array.isArray(order.items) ? order.items : JSON.parse(order.items);
    const isPaid = order.payment_confirmed;

    el("orderId").textContent = order.order_id;
    el("createdAt").textContent = order.created_at?.split("T")[0] || "-";
    el("paymentStatus").textContent = isPaid
      ? `í™•ì¸ë¨ (${order.payment_date?.split("T")[0] || '-'})`
      : "ë¯¸í™•ì¸";
    const showArrivalDue = order.payment_confirmed && !order.confirmation_note;
    el("incomingDate").textContent = showArrivalDue
      ? getArrivalDueText(items)
      : "";
    el("name").textContent = order.name || "-";
    el("phone").textContent = order.phone || "-";
    el("email").textContent = order.email || "-";
    el("address").textContent = `${order.zipcode || ''} ${order.address || ''} ${order.address_detail || ''}`;
    el("receiptInfo").textContent = order.receipt_info || "-";
    el("tracking_number").textContent = order.tracking_number || "-";

    // âœ… confirmation_note ì¶œë ¥ ì˜ì—­
    const noteContainer = document.getElementById("confirmationNoteContainer");
    noteContainer.innerHTML = order.confirmation_note
      ? `<div style="background:#ffecec; color:#c00; font-weight:bold; padding:10px; border:1px solid #faa; margin:20px 0;">
          âš  ì¬ì£¼ë¬¸ í•„ìš”: ${order.confirmation_note}
        </div>`
      : "";

    renderOrderTable(items, order.total || 0, showArrivalDue);
  } catch (e) {
    alert("ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    console.error(e);
  }
}

    function getArrivalDueText(items) {
      const arrivalDates = items.map(i => i.arrival_due?.trim()).filter(Boolean);
      return arrivalDates.length ? [...new Set(arrivalDates)].join(" / ") : "ì§„í–‰ì¤‘";
    }

    function renderOrderTable(items, total, showArrivalDue) {
  const container = document.getElementById("orderTableContainer");
  let html = `
    <table>
      <thead>
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ë‹¨ê°€</th>
          <th>í•©ê³„</th>
          <th>
  ì…ê³ ì˜ˆì •
  <span style="cursor: help;" title="ì…ê³ ì˜ˆì • ë‚ ì§œëŠ” ìƒí™©ì— ë”°ë¼ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
    ğŸ›ˆ
  </span>
</th>
        </tr>
      </thead>
      <tbody>
  `;

  let sum = 0;
  let qtyTotal = 0;

  items.forEach(item => {
    const qty = Number(item.qty || 0);
    const price = Number(item.price || 0);
    const subtotal = qty * price;
    qtyTotal += qty;
    sum += subtotal;

    const arrivalDueText = showArrivalDue
      ? (item.arrival_due?.trim() || "ì§„í–‰ì¤‘")
      : "";

    html += `
      <tr>
        <td>${item.name}</td>
        <td>${qty}</td>
        <td>${price.toLocaleString()}ì›</td>
        <td>${subtotal.toLocaleString()}ì›</td>
        <td>${arrivalDueText}</td>
      </tr>
    `;
  });

  const shipping = Math.max(total - sum, 0);

  // html += `
  //   <tr>
  //     <td>ë°°ì†¡ë¹„</td>
  //     <td></td>
  //     <td>${shipping.toLocaleString()}ì›</td>
  //     <td></td>
  //     <td></td>
  //   </tr>`;
      
    html += `  
    <tr class="total">
      <td>ì´ê³„</td>
      <td>${qtyTotal}</td>
      <td></td>
      <td>${total.toLocaleString()}ì›</td>
      <td></td>
    </tr>
  </tbody></table>`;

  container.innerHTML = html;
}

    fetchOrderInfo();
  </script>
</body>
</html>
